# 说技术——对于公共模块的思考
## 背景
作为一个工作了十几年的老码农，总有不得不面对所谓的“屎山”代码的时候。

最近，当有个需求需要我加一个错误代码的弹窗时，就遇到了类似的情况。一个check函数几百行，里面几十个if else相互嵌套着。注释是基本没有的，判断条件粗粗一看也不在同一个层次上，不知道是否有语义重叠的地方。改是改不动，删也删不掉，最后只能再加个大大的if else完事。

类似的情况还出现在工具类里。从任何理论角度来说，代码复用都是合理的。但现实是，由于持续不断的迭代，代码里逐步添加各种的Util,Helper,Mgr。各位兄弟姐妹再按照各自的习惯命名，按照各自的粒度封装，传入各自场景的参数...直到最后，每一次都只能自己新写一个方法放在工具类里。毕竟，我怎么可能迅速的知道一个跳转浏览器的方法到底是在UIUtil里、WebHelper里还是NavigationMgr里，是叫jump还是browser又或者是navTo。

思来想去，这个事情似乎值得好好聊一聊。在看过的书里似乎提到过一个专有名词来形容这种情况——公地悲剧。本文将首先介绍公地悲剧这一概念的出处，随后分三个场景分别从社会现实和代码角度介绍治理的思路。本文将主要关注于面对公地场景时的思路，并不会过多的探讨操作细节。想要了解细节的朋友们，可以参考这篇文章：https://ustcqidi.github.io/2025/02/02/webservice-refactor/#more

## 公地的悲剧
《The Tragedy of the Commons》是1968年，由美国学者Garrett Hardin在《Science》上发表的一篇文章。原文其实想要讨论的是人口增长对于环境带来的压力，即当生产力无法承载人口增长时的风险。为了引出这一话题，文章在一开始引用了一个古老的例子，即公地的悲剧。我们这里不对文章内容本身的对错进行过多的探讨，而是将关注点放在原文的切入点上。相比于文章的主题内容，“公地悲剧”的概念则在之后受到了更热烈的追捧，广泛的应用于经济、社会等各个学科和领域。

原文的内容可以大体上概括如下：
### 公地自由带来整体毁灭
想象有一片公共的大草原，对所有牧民开放。作为理性人，每名牧民都追求取得最大得益。或明或暗，有意无意，牧民扪心自问：“牛群多添一头，对我有什么效益？又有什么坏处呢？” 假设多一头牛带来了正面和负面的影响可以表达为函数f(1)，那么
- 假设多一头牛带来了正面的收益为f(1)，即出售这只牛的收益全归特定牧民所有。
- 假设多一头牛造成的过度放牧的负面影响为t(1)。因为过度放牧的效果由全体牧民承担，所以任何一位牧民作出多养一只牛的决定，负面收益为t(1)/n。
- 大部分时候f(1) >> t(1)/n。也就是，牧民多养一只牛带给自己的收益远大于带给自己的危害。  

公地悲剧是如此发展的：即每个牧民都意识到应该在公地饲养尽可能多的牛。悲剧因此而起。每个牧民都是被驱使着无限制地增加牛的数量，但草原是有限的。同样的情况还发生在海洋资源开发、水资源使用、国家森林公园等场景里。

在一个信奉公地自由的社会里，每个人都会追求本人的最好利益，而承担很少追求利益所带来的代价。与此同时，资源整体则会走向毁灭的终点，即公地自由带来整体毁灭。

### 公地污染
公地悲剧的另一种情况是污染问题。这类问题的特点不是从公地获取某些东西，而是往河流中排放污水，往土地里填埋重金属污染物，往空气中排放有毒有害的气体等。甚至，在视线所及的地方，树立令人分神和不安的广告，也是一种公地污染。理性人发觉他向公地排放废物的成本，是少于排放前洁净废物的成本，这显然也是很多高污染企业的商业逻辑。

回归到现实中，大自然是有着自清洁能力的。因此，污染问题更多的表现为人口增长的后果。未开发地区的孤独居民如何处置废弃物，通常是没有所谓的。但当人口变得密集，比如聚集生活在城市中时，大自然的化学和生物循环过程负荷就会变得不堪重负。

或许，对于人口问题最简单的总结是：公地只可以在低人口密度的条件下成立。随着人类人口增加，公地的观点必须逐一放弃。

### 对策
无论对于公地自由还是公地污染，最简单直接的对策都是将公地变为权责明确的私立。原文作者给的结论如下：
- 我们先放弃在公地采集食物，把农地圈围起来，草原，猎区和渔区列为禁区。
- 稍后，我们所见公地作为废物处置地亦要放弃。现在世界普遍接受限制家庭污水排放；但我们仍要努力从公地排除汽车、工厂、杀虫剂、施肥、和核电装置的污染。
- 另外，我们不得不承认的一点是，放弃生育的公地。没有技术性的解决办法可以从人口过多的忧愁中拯救我们。生育自由会毁灭全体。

## 公地的治理
在我们当前的语境下，公地悲剧普遍被用于形容这样一种情况：不受约束的公共资源，一定会被自私的个体过度消耗。也就是说，有限的资源注定因自由使用和不受限的要求而被过度剥削。代码，显然是一种公共资源，而且大部分时候代码书写本身都没有受到良好的约束。我们很自然的会联想到自己公司的代码是怎么样一个情况，code review的如何进行的，老板们又是如何不在乎实现细节的。

仔细回看一下公共治理领域的公地悲剧的概念。如果公地最终导致了悲剧，那么似乎需要具备如下条件：
- 公地没有具体归属，即责任人。
- 侵害公地带来的收益归属个体，代价却归于群体均摊。也就是对于个体来说，收益往往明显大于代价。
- 没有人真正关注长期后果。

对应的，我们似乎有了一些治理公地的思路，下面就一一阐述。

### 方案1——公地私有化
#### 从圈地运动说起
历史上，公地悲剧的发生及相关治理，存在很多现实的案例。文章开头提到的关于放牧的公地问题，在英国历史上就曾有过类似的情况。英国的中世纪时期确实有过公地制度，而且确实带来了一些问题。（在这里，我们不去深究究竟是什么样复杂的历史因素导致了公地制度的诞生。）随后，随着资本主义萌芽，纺织业兴起，圈地运动出现了。臭名昭著的羊吃人的圈地运动，是英国的新贵族和资产阶级强行将农民的份地和公有地圈占为牧羊场，驱逐农民，使他们成为流浪者或雇佣劳动者。其主要通过暴力手段对土地进行私有化，在带给底层人民悲惨命运的同时，却也极大的促进了生产力和生产关系的进步。

从本文讨论的主题出发，将公地私有化，明确其所属，看起来就是最简单直接的解决公地问题的办法。但是从历史案例我们也能看出来，公共资源随便就私有化了也会带来大量的问题，是需要权衡利弊的。
#### 登录模块
回到我熟悉的领域。

当我接手登录模块的时候，此模块已经几易其手了。代码风格上存在明显的不协调，显然，过去的负责人里，有人喜欢Activity有人喜欢Fragment，有人喜欢都写在一起有人喜欢MVC。对于逻辑代码和页面展现封装的层次差异也很大。不同的登录方式，比如第三方登录、SSO登录等，被强行抽象在一起。还有一些诸如风控检测、登录失败的代码则复制粘贴般的散落在多处。负责登录模块的产品经理也变过好几个了，现有的一些细节逻辑我甚至怀疑是开发参考其他客户端的“合理流程”，自行决定的。也就是登录模块连个话事人都没有了。

由于过去的种种变更，登录这个重要模块已经展现出了公地悲剧的初步样貌。如果我试着把这个模块私有化，会发生什么呢。冷静下来分析一下登录模块的现状如下：
- 登录模块的现状是没有频繁的需求变化。——私有化的成本可以承受
- 一旦有需求基本都很急，基本无法推迟。——私有化带来效率的提高
- 登录是大家最常用的功能，所有人都对此很敏感。一旦出事就很麻烦。——私有化对责任人要求很高
- 登录的bug几乎每次发版的时候，QA都会遇到。尽管bug几乎都是环境问题，但及时响应是必须的。——私有化提升了响应效率
- 大部分同事并不想碰登录的细节流程。一来代码看起来费劲，二来不想承担regression的风险。——私有化降低了大部分人的压力

基于上述思路，考虑将登录模块私有化，即我来当负责人，成为了解决问题的最高效的办法：
- 首先，对所有人声明，我来当登录模块的负责人，有任何问题请直接@我。不需要再去考虑这个短信登录是谁写的，这个二次验证又是什么时候开发的。这种情况是老板和测试是极其乐意见到的。
- 其次，定义好一套对外暴露的登录服务的接口。再将相关代码归拢到统一路径下，并最终把这些代码独立出来，比如封装成aar。将登录模块的细节对其他人变成黑盒。这样子有效防止了别人乱改我代码，同时降低我和他人的压力。
- 添加好文档、注释和log。先把现有代码逻辑梳理一下，尤其是主流程。在关键位置加好log和注释，文档也适当写一点。确保自己有能力快速响应需求变更或者bug定位。以最低的代价维持这块坡地就行了，后续发现自己脱不了身了再进行下面两项：
- 引入针对登录的自动化测试。关注输入输出，确保功能运行稳定。
- 有闲暇时再按照自己的习惯重构呗。显然，我懒得重构。

经过这么一系列行为，登录模块的性质就从一个公共模块变成了私有模块。显然，老板们并不关心代码实现是否优雅易读。只要账号能登录上，没有人投诉，就可以了。对于测试和其他的开发，一旦涉及到登录的问题，也很喜爱这种“去找xx吧”，有效降低了他们的负担和责任。至于我本人，扛了个重要模块的负责人，但只是把代码挪动了个位置，然后在debug的时候按步骤加点注释，就这么小心翼翼地呵护住了“屎山”。总体成本并不高，收益却还可以。

### 方案2——共同治理
#### 土耳其渔场
土耳其渔场的治理经验主要体现在土耳其阿兰亚渔场的自主治理案例中，该案例被很多学者视为公共池塘资源成功治理的典范。20世纪70年代，阿兰亚近海渔场面临着资源枯竭：渔场规模有限，鱼类资源因无节制捕捞急剧减少。渔民为争夺优质捕捞区域频繁发生争端，导致生产成本上升和社会不稳定。政府的集中管制和私有化方案均未奏效。渔民既不愿接受外部强制管理，也难以通过市场分割解决鱼群在渔场中的流动性问题。

阿兰亚渔民通过十余年的内部协商，形成了一套自组织规则，具体包括以下核心机制：
- 仅允许持有执照的当地渔民参与捕捞，明确资源使用权限。
- 每年9月对合格渔民登记并抽签分配捕捞区域，确保公平性。
- 9月至次年1月，渔民每天向东迁移一个捕捞点。1月至5月则向西迁移，顺应鱼类洄游规律。
- 规则由渔民自行监督，违反者将面临社区内部的分级制裁（如警告、驱逐）。

这一套规则执行下来，成效是显著的：
- 渔民通过协商制定规则，且绝大多数受影响者参与规则修改。规则通过长期试错形成，具有灵活性。
- 捕捞点轮换制度基于鱼类迁徙规律和地理特点设计，具备本土适应性。通过动态轮换，鱼类种群局部恢复，渔民收入趋于稳定。
- 抽签和轮换制度消除了争夺捕捞点的冲突，增强了社区信任。通过社区自治实现公共资源的有效管理，内部快速处理争端，避免传统国有化或私有化的弊端。

#### 设置页
回到代码层面。  
对于大部分的客户端应用，大家都一定见过“设置”页面，里面按照着一定的规则堆砌着海量的设置项。当我作为一个使用者时，我大部分时候是搞不清楚具体有多少设置，哪个设置在哪的。尤其是当我看见“通用”或者“其他”的时候，我觉得这里就是无处安放的设置项的垃圾场。

而当我作为一个开发者时，我总是会在做一个大需求的时候顺带着在设置页面加上一两项。我只是简单找到符合要求的层级位置，复制前面一个设置的代码，然后改改字符串和Key。我从来不去考虑这里的代码结构是否优雅，用户的使用体验是否合理，我只是想尽可能简单的完成它。复用前面的概念，这是一个典型的公地污染案例。

但是想要把设置页私有化，即指定一个责任人，是有一些困难的。
- 设置页的变更太频繁了。任何人如果负责设置页，都意味所有精力都放在设置页上。任何老板，都不会把负责设置页作为一项有价值的工作。这就会变得干得很苦，却没啥亮眼产出。
- 正是由于设置页是所有人都会改到的，所以抽离独立出来，然后封装起来，也变得不合适了。
- 正确实现设置页需要的知识很杂乱。要求一个人掌握App里的所有功能是不现实的。让这个负责人告诉每个需求的开发对应的key是啥，也是个海量的工作。
- 任何测试，也不会单独测试设置页本身，都是要跟功能联动的。

于是，大部分情况下，设置页成为了三不管地带。作为一个人人都会插一脚的公地模块，代码量持续膨胀，也是相当让人头疼的。对于设置页的治理，土耳其渔场的治理经验似乎可以给我们那么一点启发:
- 制定一套有共识的代码规则。例如，让所有人协商设置页的代码书写规则，让大家在书写设置页时代码风格保持一致。甚至提供一个设置项的代码模板供大家复制粘贴。
- 建立一套检查制度，例如代码静态扫描，确保所有人都不会主动污染设置页。适度邀请大家集体进行code review也会起到积极的作用。
- 在此基础上逐步把设置页的代码模版化，例如，把基础行为等提取出来。让所有人从改动同一个文件变成各改各的文件，即进一步的解耦，这样可以有效减少代码阅读和维护的难度。
- 进一步优化配置项的生成。如果能够通过配置文件生成配置项，那么设置页就成为了一个独立于业务的框架模块，就具备了私有化的潜力和价值。

在这个场景下，直接私有化是不太合理的，会有很多问题。及时制定共识规则、进行共同治理是一个更加合适的思路。当然，没有什么事情是绝对的。承认设置页的投入产出性价比太低也是不要贸然把设置页私有化的重要考量。

### 方案3——混合模式
#### 内蒙古草场治理
早在1980年代初期，集体的牲畜就被承包到农户，这刺激了农户增加牲畜的积极性。随着牲畜数量的增加，草原受到了越来越大的压力。过度放牧导致了草原的退化，草的覆盖度降低，许多地方出现了沙化。这一问题看起来是由于牧民在追求个体利益最大化时忽视了集体成本，缺少长期规划，最终导致资源枯竭，草地逐渐退化为沙地。这一问题是一个典型的公地悲剧。  
在治理初期，我国采取的思路是承包制，也就是把草场资源从公有制改为承包到个人。在1990年代中后期，一些地方开始将草场承包到农户，希望通过承包可以激发村民保护建设草场的积极性，从而在增加村民收入的同时，也可以保护草原。与农田不同，草原上的牲畜是流动的，因此需要建设大量围栏。从1990年代后期开始了大规模的网围栏建设。包围在网围栏中的草场具有了明确的归属。像人们所预期的一样，减少了放牧以后，围栏内的植被迅速恢复，但是这并没有扭转草原整体退化的趋势，尽管网围栏内越来越绿，草越长越高，但是在网围栏外面，放牧的羊只不断增加，草场退化的趋势愈演愈烈。另一方面，并不是所有牧民都可以有一块边界清晰的草场供自己使用，其中存在着经济、环境、执行等各方面的因素。这里又有了一个新词，叫“围栏陷阱”。  
随后，我国又尝试了一系列公有制方式，比如禁牧、围封、补贴等，并为此建立了一系列的检查、管理机制。在这种情况下，通过外部权利强制约束了牧民的行为，但也带来了监管成本高昂，牧民抵触甚至产生矛盾等一系列问题。为此，近些年来相关措施进一步进化。包括培养旅游产业、地理标志产品、引入光伏扶贫等等。通过这一系列措施，降低了放牧与牧民的利益相关性，降低了牧民对于限制放牧的抵触情绪。从更高的维度上多管齐下，对公地悲剧的治理做出了有益的尝试。  
在这一个典型案例中，无论是公地私有化还是靠牧民集体管理，效果都不够好。而过度放牧带来的影响并不仅仅是牧民本身，还涉及到整体的生态退化、比如首都沙尘暴。因此，持续的投入，想办法改善是值得的。目前的相对可持续的路线是在一系列的探索中修修补补获得，借由国家这个强大实体对牧民集体一方面做出利于长远的强制约束，另一方面又主动做出教育、引导并解决收入问题。
#### 应用启动
应用启动速度几乎是所有公司的所有老板都会在意的事情，但应用启动本身通常不是以一个单独模块而单独存在的。大部分时候，你这个模块加一个init，我那个模块加一个install，今天多load两个so，明天多执行一段代码。日积月累下来，应用启动速度慢就成为了一个典型的公地悲剧问题。
以我的既往经验，对于应用启动速度的关注通常是这样发生的：
- 老板自己试用或者大客户试用发现速度很慢，忍不了。
- 打开应用商店，发现骂声一片。其他反馈渠道也全是抱怨。
- 老板急了，我们做功能怎么能影响到启动速度呢，给我改。
- 高管们急了，老板都重视了，那我们必须在x秒内见到主页。
- 经理们急了，大佬们都重视了，我们要立刻马上做出效果来。  

这个时候，应用启动速度的优化就提上日程了。这个事情本身价值高，就像登录一样，是踩在老板的点上的，所以值得做一些投入。但想要完全私有化登录模块并不合适，像设置页一样改动不算少，涉及到的面很广。但是全靠大家共同治理也不现实，因为没人想要故意多加初始化代码，完全是功能的自然增长就导致启动速度爆炸了。

这时，让我们思考内蒙古草场的案例，发现在此场景下老板扮演了与国家类似的强有力的外部实体的角色。而我如果把自己定位成草场监察机构，那么牧民基本也能对应到各位开发。从混合管理的角度思考：
- 一方面我应该要作为专项治理的负责人，背上启动速度的kpi了，因为我是拿这份钱干这份工。这是老板在乎的事，得干。
- 另一方面，这事不能全靠我干，还是要大家配合。压力要给到，但不能上强制手段。就像你不能因为放牧矛盾就把牧民抓派出所。所以我要借着老板的鸡毛当令箭来约束大家的行为。
- 最后，我想要牵头人持续的躺在功劳簿上，但并不想被吊死在这棵树上。所以，还需要想办法宣传引导一些老板的关注点和诉求，就像教育牧民有可持续发展的思维一样。这样我才能逐步降低我自己在这件事上投入的精力，让大家多少都投入一点精力进来。

具体的操作可以有很多的方式，随便列举几个：
- 分析具体的耗时，找到主要矛盾，借助老板的威力压制对应的开发修改
- 评估各个模块的优先级，延迟加载其中一部分
- 做好汇报和宣讲。一定要把老板和开发都喊到场，狐假虎威
- 还可以亲自下场先做好某一块的范例，然后诱导其他人不得不遵守

## 总结
总的来说，公地悲剧的治理是一个没有标准答案的问题。需要的是因地制宜、寻找最合适的方式方法。文中列举的三个场景及相对应的思考和措施，只是我个人职业生涯中的一些典型经验，供大家参考。