# 说技术——对于公共模块的思考
## 背景
作为一个老码农，总是有不得不面对所谓的“屎山”代码的时候。最近，当我需要加一个错误代码的弹窗时，就遇到了类似的情况。一个check函数几百行，里面几十个if else相互嵌套着。注释是没什么的，判断条件也不在统一的层次上，都不知道是否有语义重叠的地方。改也改不动，删也删不掉，最后只能再来个大大的if else。

类似的情况还出现在工具类里。从任何理论角度来说，代码的重用都是合理的。但现实是，由于持续不断的迭代，代码里逐步添加各种的Util,Helper,Mgr。各位兄弟姐妹再按照各自的习惯命名，按照各自的粒度封装，传入各自场景的参数...直到最后，每一次都只能自己新写一个方法放在工具类里。毕竟，我怎么可能迅速的知道一个跳转浏览器的方法到底是在UIUtil里、WebHelper里还是NavigationMgr里，是叫jump还是browser又或者是navTo。

思来想去，这个事情似乎值得好好聊一聊。在看过的书里似乎提到过一个专有名词来形容这种情况——公地悲剧。

## 公地的悲剧
《The Tragedy of the Commons》是1968年，由美国学者Garrett Hardin在《Science》上发表的一篇文章。原文其实想要讨论的是人口增长对于环境带来的压力，即当生产力无法承载人口增长时的风险。为了引出这一话题，文章在一开始引用了一个古老的例子，即公地的悲剧。我们这里不对文章内容本身的对错进行过多的探讨，而是将关注点放在原文的切入点上。相比于文章的主题内容，“公地悲剧”的概念则在之后受到了更热烈的追捧，广泛的应用于经济、社会等各个学科和领域。

原文的内容可以大体上概括如下：
#### 公地自由带来整体毁灭
想象有一片公共的大草原，对所有牧民开放。作为理性人，每名牧民都追求取得最大得益。或明或暗，有意无意，牧民扪心自问：“牛群多添一头，对我有什么效益？又有什么坏处呢？” 假设多一头牛带来了正面和负面的影响可以表达为函数f(1)，那么
- 假设多一头牛带来了正面的收益为f(1)，即出售这只牛的收益全归特定牧民所有。
- 假设多一头牛造成的过度放牧的负面影响为t(1)。因为过度放牧的效果由全体牧民承担，所以任何一位牧民作出多养一只牛的决定，负面收益为t(1)/n。
- 大部分时候f(1) >> t(1)/n。也就是，牧民多养一只牛带给自己的收益远大于带给自己的危害。  

公地悲剧是如此发展的：即每个牧民都意识到应该在公地饲养尽可能多的牛。悲剧因此而起。每个牧民都是被驱使着无限制地增加牛的数量，但草原是有限的。同样的情况还发生在海洋资源开发、水资源使用、国家森林公园等场景里。

在一个信奉公地自由的社会里，每个人都会追求本人的最好利益，而承担很少追求利益所带来的代价。与此同时，资源整体则会走向毁灭的终点，即公地自由带来整体毁灭。

#### 公地污染
公地悲剧的另一种情况是污染问题。这类问题的特点不是从公地获取某些东西，而是往河流中排放污水，往土地里填埋重金属污染物，往空气中排放有毒有害的气体等。甚至，在视线所及的地方，树立令人分神和不安的广告，也是一种公地污染。理性人发觉他向公地排放废物的成本，是少于排放前洁净废物的成本，这显然也是很多高污染企业的商业逻辑。

回归到现实中，大自然是有着自清洁能力的。因此，污染问题更多的表现为人口增长的后果。未开发地区的孤独居民如何处置废弃物，通常是没有所谓的。但当人口变得密集，比如聚集生活在城市中时，大自然的化学和生物循环过程负荷就会变得不堪重负。

或许，对于人口问题最简单的总结是：公地只可以在低人口密度的条件下成立。随着人类人口增加，公地的观点必须逐一放弃。

#### 对策
无论对于公地自由还是公地污染，最简单直接的对策都是将公地变为权责明确的私立。原文作者给的结论如下：
- 我们先放弃在公地采集食物，把农地圈围起来，草原，猎区和渔区列为禁区。
- 稍后，我们所见公地作为废物处置地亦要放弃。现在世界普遍接受限制家庭污水排放；但我们仍要努力从公地排除汽车、工厂、杀虫剂、施肥、和核电装置的污染。
- 另外，我们不得不承认的一点是，放弃生育的公地。没有技术性的解决办法可以从人口过多的忧愁中拯救我们。生育自由会毁灭全体。

## 公地的治理
在当前的语境下，公地悲剧普遍被用于形容这样一种情况：不受约束的公共资源，一定会被自私的个体过度消耗。也就是说，有限的资源注定因自由使用和不受限的要求而被过度剥削。代码，显然是一种公共资源，而且大部分时候代码书写本身都没有受到良好的约束。我们很自然的会联想到自己公司的代码是怎么样一个情况，code review的如何进行的，老板们又是如何不在乎实现细节的。

仔细回看一下公共治理领域的公地悲剧的概念。如果公地最终导致了悲剧，那么似乎需要具备如下条件：
- 公地没有具体归属，即责任人。
- 侵害公地带来的收益归属个体，代价却归属于群体均摊。也就是对于个体来说，收益往往明显大于代价。
- 没有人真正关注长期后果。

对应的，我们似乎有了一些治理公地的思路，下面就来一一阐述。

### 公地私有化
#### 从圈地运动说起
历史上，公地悲剧的发生及相关治理，存在很多现实的案例。文章开头提到的关于放牧的公地问题，在英国历史上就曾有过类似的情况。英国的中世纪时期确实有过公地制度，而且确实带来了一些问题。（在这里，我们不去深究究竟是什么样复杂的历史因素导致了公地制度的诞生。）随后，随着资本主义萌芽，纺织业兴起，圈地运动出现了。臭名昭著的羊吃人的圈地运动，是英国的新贵族和资产阶级强行将农民的份地和公有地圈占为牧羊场，驱逐农民，使他们成为流浪者或雇佣劳动者。其主要通过暴力手段对土地进行私有化，在带给底层人民悲惨命运的同时，却也极大的促进了生产力和生产关系的进步。

从本文讨论的主题出发，将公地私有化，明确其所属，看起来就是最简单直接的解决公地问题的办法。但是从历史案例我们也能看出来，公共资源随便就私有化了也会带来大量的问题，是需要权衡利弊的。
#### 登录模块
回到我熟悉的领域。

当我接手登录模块的时候，此模块已经几易其手了。代码风格上存在明显的不协调，显然，过去的负责人里，有人喜欢Activity有人喜欢Fragment，有人喜欢都写在一起有人喜欢MVC。对于逻辑代码和页面展现封装的层次差异也很大。不同的登录方式，比如第三方登录、SSO登录等，被强行抽象在一起。还有一些诸如风控检测、登录失败的代码则复制粘贴般的散落在多处。负责登录模块的产品经理也变过好几个了，现有的一些细节逻辑我甚至怀疑是开发参考其他客户端的“合理流程”，自行决定的。也就是登录模块连个话事人都没有了。

由于过去的种种变更，登录这个重要模块已经展现出了公地悲剧的初步样貌。冷静下来分析一下登录模块的现状如下：
- 登录模块的现状是没有频繁的需求变化。
- 一旦有需求基本都很急，基本无法推迟。
- 登录是大家最常用的功能，所有人都对此很敏感。一旦出事就很麻烦。
- 登录的bug几乎每次发版的时候，QA都会遇到。尽管bug几乎都是环境问题，但及时响应是必须的。
- 大部分同事并不想碰登录的细节流程。一来代码看起来费劲，二来不想承担regression的风险。

基于此，直接将登录模块私有化，即我来当负责人，成为了解决问题的最高效的办法。我的操作步骤如下：
- 首先，对所有人声明，我来当登录模块的负责人，有任何问题请直接@我。不需要再去考虑这个短信登录是谁写的，这个二次验证又是什么时候开发的。
- 其次，定义好一套对外暴露的LoginService接口。再将相关代码归拢到统一路径下，并最终把这些代码独立出来，比如封装成aar。将登录模块的细节对其他人变成黑盒。
- 添加好文档、注释和log，确保自己有能力快速响应需求变更或者bug定位。先把现有代码逻辑梳理一下，尤其是主流程。在关键位置加好log和注释，文档也适当写一点。
- 引入针对登录的自动化测试。关注输入输出，确保功能运行稳定。
- 有闲暇时再按照自己的习惯重构呗。显然，我懒得动重构了。

经过这么一系列处理，登录模块就从一个公共模块变成了私有模块。显然，老板们并不关心代码实现是否优雅易读。只要账号能登录上，没有人投诉，就可以了。对于测试和其他的开发，一旦涉及到登录的问题，也很喜爱这种简单直接的沟通方式，有效降低了他们的负担和责任。至于我本人，扛了个重要模块的负责人，但只是把代码挪动了个位置，然后在debug的时候按步骤加点注释。这么一套下来，工作量并不大，甚至小心翼翼地避开了“屎山”。

### 共同治理
#### 土耳其渔场
土耳其渔场的治理经验主要体现在土耳其阿兰亚渔场的自主治理案例中，该案例被很多学者视为公共池塘资源成功治理的典范。

20世纪70年代，阿兰亚近海渔场面临着资源枯竭：渔场规模有限，鱼类资源因无节制捕捞急剧减少。渔民为争夺优质捕捞区域频繁发生争端，导致生产成本上升和社会不稳定。政府的集中管制和私有化方案均未奏效。渔民既不愿接受外部强制管理，也难以通过市场分割解决鱼群在渔场中的流动性问题。

阿兰亚渔民通过十余年的内部协商，形成了一套自组织规则，具体包括以下核心机制：
- 仅允许持有执照的当地渔民参与捕捞，明确资源使用权限。
- 每年9月对合格渔民登记并抽签分配捕捞区域，确保公平性。
- 9月至次年1月，渔民每天向东迁移一个捕捞点。1月至5月则向西迁移，顺应鱼类洄游规律。
- 规则由渔民自行监督，违反者将面临社区内部的分级制裁（如警告、驱逐）。

这一套规则执行下来，成效是显著的：
- 渔民通过协商制定规则，且绝大多数受影响者参与规则修改。规则通过长期试错形成，具有灵活性。
- 捕捞点轮换制度基于鱼类迁徙规律和地理特点设计，具备本土适应性。通过动态轮换，鱼类种群局部恢复，渔民收入趋于稳定。
- 抽签和轮换制度消除了争夺捕捞点的冲突，增强了社区信任。通过社区自治实现公共资源的有效管理，内部快速处理争端，避免传统国有化或私有化的弊端。

#### 设置页
回到代码层面。对于大部分的客户端应用，大家都一定见过“设置”页面，里面按照着一定的规则堆砌着海量的设置项。当我作为一个使用者时，我大部分时候是搞不清楚具体有多少设置，哪个设置在哪的。尤其是当我看见“通用”或者“其他”的时候，我觉得这里就是无处安放的设置项的垃圾场。

而当我作为一个开发者时，我总是会在做一个大需求的时候顺带着在设置页面加上一两项。我只是简单找到符合要求的层级位置，复制前面一个设置的代码，然后改改字符串和Key。我从来不去考虑这里的代码结构是否优雅，用户的使用体验是否合理，我只是想尽可能简单的完成它。复用前面的概念，这是一个典型的公地污染案例。

但是想要把设置页私有化，即指定一个责任人，是有一些困难的。
- 设置页的变更太频繁了。任何人如果负责设置页，都意味所有精力都放在设置页上。
- 正是由于设置页是所有人都会改到的，所以抽离独立出来，然后封装起来，也就变得不合适了。
- 正确实现设置页需要的知识也很杂乱。要求一个人掌握App里的所有功能是不现实的。
- 任何老板，都不会把负责设置页作为一项有价值的工作。任何测试，也不会单独测试设置页本身，都是要跟功能联动的。

于是，设置页自然而然的成为了三不管地带。作为一个人人都会插一脚的公地模块，代码量持续膨胀，也是相当让人头疼的。对于设置页的治理，土耳其渔场的治理经验似乎可以给我们那么一点启发:
- 制定一套有共识的代码规则。例如，让所有人协商设置页的代码书写规则，让大家在书写设置页时代码风格保持一致。提供一个设置项的代码模板供大家复制粘贴。
- 建立一套检查制度，例如代码静态扫描，确保所有人都不会主动污染设置页。适度邀请大家进行code review也会起到积极的作用。
- 在此基础上，逐步把这个模板抽象化，例如，把基础行为等提取出来。让所有人从改动同一个文件变成各改各的文件。这样可以有效减少代码阅读和维护的难度。
- 进一步优化配置项的生成。如果能够通过配置文件生成配置项，那么设置页就具备了私有化的潜力。

对于那些难以直接私有化的模块，制定共识规则、进行共同治理是一个合适的思路。

### 混合模式
#### 内蒙古草场治理
http://www.card.zju.edu.cn/2005/1015/c24475a917209/page.htm 浙江大学农村发展研究院
#### 应用启动
#### 应用主页
